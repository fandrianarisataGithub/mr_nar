{% extends "base.html.twig" %}
{% block title %}Client présent
{% endblock %}
{% block body %}
	<aside class="compteur container-fluid">
		<div class="col-md-6"></div>
		<div class="compteur_content col-md-6">
			<div class="details bg-primary">
				<div class="date_du_jour">
					<p>Date du jour:
						<span class="val_date">{{ date_du_jour | date('d-m-Y') }}</span>
					</p>
				</div>
				<div class="total_montant_mensuel">
					<p>Montant total mensuel du jour:
						<span>{{ total_mmj }}</span>
						<span>Ariary</span>	
					</p>
				</div>
				<div class="total_montant">
					<p>Montant total du jour:
						<span>{{ total_mj }}</span>
						<span>Ariary</span>	
					</p>
				</div>
				<div class="nbr_total_client">
					<p>Nombre total de client du jour:
						<span>{{ nbr_client_du_jour }}</span>
						<span>client(s)</span>
					</p>
				</div>
				<div class="nbr_total_client">
					<p>Nombre total de clients présents:
						<span>{{ present }}</span>
						<span>client(s)</span>
					</p>
				</div>
			</div>
		</div>
	</aside>

	<div class="titre_page">
		<h2>Liste des clients présents (pour le pointage)</h2>
	</div>

	<div class="tableau tab_historique">
		<table class="display" id="tab_client_heb" style="width:100%">
			<thead>
				<tr>
					<td>
						<span>MATRICULE</span>
					</td>
					<td>
						<span>NOM ET PRENOM</span>
					</td>
					<td>
						<span>CLIENT DE</span>
					</td>
					<td>
						<span>DETAIL DU PAIEMENT</span>
					</td>
					<td>
						<span>DATES</span>
					</td>
					<td>
						<span>ACTIONS</span>
					</td>
				</tr>
			</thead>
			<tbody>
				{% for item in items %}
					<tr>
						<td class="td-check">
							<span>{{ item.matricule }}</span>
							{% if item.verifier == "oui" %}
								<b class=" check fa fa-check"></b>
							{% else %}
								<b class=" check fa "></b>
							{% endif %}
							<b class=" check check-hide fa fa-check" style="display:none"></b>
						</td>
						<td>
							<span>{{ item.nom }}</span><br>
							<span>{{  item.prenom }}</span>
						</td>
						<td>
							<span>{{ item.getUser().nom }}</span><br>
							(<span>{{ item.getUser().username }}</span>)
						</td>
						<td>
							<span>N° BL:</span>
							<span class="unite">{{ item.getNumeroBl() }}</span>
							<br>
							<span>MONTANT:</span><b class="unite">{{ item.montant }}</b><b class="unite">Ar</b>
							<br>
							<span>MONTANT MENS:</span><b class="unite">{{ item.getMontantMensuel() }}</b><b class="unite">Ar</b>
							<br>
							
							<span>NBR VERSEMENT:</span><b class="unite">{{ item.getNbrVersement() }}</b>
						</td>
						<td>
							<span>DATE DE DEBUT:</span><span class="unite">{{ item.getDateDebut() | date('Y-m-d') }}</span>
							<br>
							<span>DATE DE DEBUT:</span><span class="unite">{{  item.getDatefin() | date('Y-m-d') }}</span>
						</td>
						<td>
							<div class="action">
								<div>
									<a href="{{ path("edit_client", {"id": item.id }) }}" class="modif btn btn-info btn-xs" {% if is_granted("ROLE_ADMIN") %} style="display:flex;" {% else %} style="display:none;" {% endif %}>
										<span class="fa fa-edit"></span>
									</a>
									<a href="#" data-id-client = "{{ item.id }}" class="suppr btn btn-danger btn-xs" {% if is_granted("ROLE_ADMIN") %} style="display:flex;" {% else %} style="display:none;" {% endif %}>
										<span class="fa fa-trash-o"></span>
									</a>
								</div>
								<div>
									<a href="#" data-id-client = "{{ item.id }}" class="verifier btn btn-primary btn-xs" {% if is_granted("ROLE_ADMIN") %} style="display:flex;" {% else %} style="display:none;" {% endif %}>
										<span class = "fa fa-check-square-o"></span>
									</a>
									<a href="{{ path('single_page', {'id_client': item.id }) }}" class="voir btn btn-primary btn-xs" {% if is_granted("ROLE_ADMIN") %} style="display:flex;" {% else %} style="display:none;" {% endif %}>
										<span>Voir</span>
									</a>
								</div>
								<div class="div__pointer">
									<a href="{{ path('autrepointage', {'id_client': item.id }) }}" data-id-client="{{ item.id }}" class=" btn btn-primary btn-xs" {% if is_granted("ROLE_ADMIN") %} style="display:flex;" {% else %} style="display:none;" {% endif %}>
										<span>Pointer</span>
										<span class="fa fa-check"></span>
									</a>
								</div>
							</div>
						</td>

					</tr>
				{% endfor %}

			</tbody>
		</table>
		<div class="titre_page footer">
			<h2>
				<a href="{{ path('imprimer_client_present') }}" class="btn btn-primary">Imprimer la liste</a>
			</h2>
		</div>

		{# modal pointage #}
			<div id="modal_pointage">
				<section class="inner_modal">
					<div class="modal_head">
						<button class="btn btn-danger">
							<span class="fa fa-times"></span>
						</button>
						<h3>
							<span>Matricule:</span>
							<span class="son_matricule">123</span>
						</h3>
						<div class="last_etat">
							<span>Dernier mois de pointage:
							</span>
							<span class="last_mois">Fevrier
							</span>/<span>
								2020</span>
						</div>
					</div>
					<form action="">
						<div class="form-group" style="width:50%; margin-left:auto;margin-right:auto;margin-top:10px;">
						<label for="">Mois de pointage : </label>
							<select class="form-control" name="" id="id_pointage" >
								{% for p in pointages %}
									<option value="{{ p.id }}">{{ p.getNomLit() }}</option>
								{% endfor %}
							</select>
						</div>
						<div class="form-group btn_action">
								<div class="form-group">
									<label>Montant (ariary):</label>
									<input type="number" class="form-control montant" name="montant" id="montant">
								</div>
								<div id="info">
									<p>Lorem ipsum dolor sit amet consectetur adipis</p>
								</div>
								<div class="form-group">
									<button type="sumbit" data-id-client = "0" id="add_pointage" class="btn btn-primary btn-sm">Enregistrer</button>
								</div>
							</div>
					</form>
					<div class="block_details">
						<div class="col-sm-6">
							<div class="form-group">
								<label for="">Nombre de mois restant:</label>
								<p class="details_client">12
									<span>mois</span>
								</p>
							</div>
						</div>
						<div class="col-sm-6">
							<div class="form-group">
								<label for="">Montant total restant:</label>
								<p class="details_clientl">12 000<span>Ariary</span>
								</p>
							</div>
						</div>
					</div>
				</section>
			</div>


	</div>
	



{% endblock %}
{% block javascripts %}
	<script>

		 $(document).ready(function() {
            var table = $('#tab_client_heb').DataTable({
                "language": {
                    "sEmptyTable": "Aucune donnée disponible dans le tableau",
                    "sInfo": "Affichage de l'élément _START_ à _END_ sur _TOTAL_ éléments",
                    "sInfoEmpty": "Affichage de l'élément 0 à 0 sur 0 élément",
                    "sInfoFiltered": "(filtré à partir de _MAX_ éléments au total)",
                    "sInfoPostFix": "",
                    "sInfoThousands": ",",
                    "sLengthMenu": "Afficher _MENU_ éléments",
                    "sLoadingRecords": "Chargement...",
                    "sProcessing": "Traitement...",
                    "sSearch": "Rechercher :",
                    "sZeroRecords": "Aucun élément correspondant trouvé",
                    "oPaginate": {
                        "sFirst": "Premier",
                        "sLast": "Dernier",
                        "sNext": "Suivant",
                        "sPrevious": "Précédent"
                    },
                    "oAria": {
                        "sSortAscending": ": activer pour trier la colonne par ordre croissant",
                        "sSortDescending": ": activer pour trier la colonne par ordre décroissant"
                    },
                    "select": {
                        "rows": {
                            "_": "%d lignes sélectionnées",
                            "0": "Aucune ligne sélectionnée",
                            "1": "1 ligne sélectionnée"
                        }
                    }
				},
				"columnDefs": [{
					"targets": 'no-sort',
					"orderable": false
				}],
                responsive: true,
                scrollY: false, // raha scrollena de asina val ex 400
                scrollX: true,
                scrollCollapse: true,
                paging: true,
                autoFill: true
            });

			new $.fn.dataTable.FixedHeader(table);
			
			// verification 

			$("tbody").on('click', ".verifier", function(e){
				e.preventDefault()
				var id_client = $(this).attr('data-id-client');
				var tr = $(this).parent().parent().parent().parent();
				var string = "";
				$.ajax({
					url : "/admin/verifier/"+id_client,
					type : "GET",
					success : function(response){
						if(response=="ok"){
							tr.children('.td-check').children(".check-hide").show();
						}
					},
					error : function(){
						alert('erreur ajax');
					}
					
				})
			})

			/* pointage */

                // function generate year

            function generateYear() {
                var today = new Date();
                //alert(today);
                var y = today.getFullYear();
                //alert(y);
                var html = "<option value = '" + y + "'>" + y + "</option>";
                for (var index = 2009; index < y + 3; index++) {
                    html += "<option value = '" + index + "'>" + index + "</option>";
                }
                $('#annee_pointage').append(html);
            }
            generateYear();

            // animation modal 

            function show_modal(){
                $('#modal_pointage').css('display', 'flex');
                $('.inner_modal').css('transform' , 'scale(1)');
            }
             function hide_modal(){
				 $(".clicked").removeClass('clicked');
                $('#modal_pointage').css('display', 'none');
                $('.inner_modal').css('transform' , 'scale(0)');
				$('#info p').slideUp();
            }

            // activation du modal 
           $('tbody').on('click', '.pointer', function(e){
			   	e.preventDefault();
				$(this).addClass('clicked');
				$('#add_pointage').attr('data-id-client',$(this).attr('data-id-client'));
				show_modal();
		   })
			$('#add_pointage').click(function(e){
				e.preventDefault();
				var id_client = $(this).attr('data-id-client');
				var id_pointage = $('#id_pointage').val();
				var montant = $('#montant').val();

				//alert('id_client:'+id_client+' id_pointage:'+id_pointage+'montant:'+montant);
				var data = {
					'pointage_id' : id_pointage,
					'montant_mensuel' : montant,
					'client_id' : id_client
				}
				// ajax
				$.ajax({
					url : "/admin/pointer_client",
					type : "POST",
					data : data,
					success : function(response){
						if(response=="0"){
							window.location.href = "{{ path('pointage') }}";
						}
						else{
							alert('Le montant entré n\'est incorrect ')
						}
					},
					error : function(){
						alert('erreur ajax');
					}
				})

			})

            // hide modal 

            $('.modal_head button').click(function(e){
                e.preventDefault();
                hide_modal();
			})


            /* /pointage */

			



        });
	
	</script>
{% endblock %}
